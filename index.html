<html>
<head>
<title>Project2</title>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link rel="stylesheet" href="./style.css">


</head>
<style>

      .outline {
        stroke: white;
        stroke-width: 1px;
        fill: none;
      }
      h1{
          font-family: 'Montserrat', sans-serif;

          color:#778472;
      }

      h2{
          font-family: 'Montserrat', sans-serif;
          size: 24;
          color:#778472;
      }
      h3{
          font-family: 'Montserrat', sans-serif;
          size: 13;
          color: #778472;
      }
      text{
        color:#778472;
        font-family: 'Montserrat', sans-serif
      }

      body{
        background: white
      }

      .textcolor{
        color:white
      }


  </style>



<body leftmargin = "50" topmargin = "50">
  <div class="larger">
    <h1>How Will The Green New Deal Impact Your State?</h1>
    <center><h3> The green new deal aims to reach carbon neutrality in the US by the year 2030.
    </br>
    </br>
    Hover over your state to see its Primary Energy Consumption Breakdown.
  </br>
  </br>
    Then, click on your state to see how your community will reach zero emissions.
  </h3> <center>


    <div id = "map">
    </br>
    </br>
      <h2>US Total Energy Consumptions in billion BTU</h2>
      <div class = "m">
        <div class = "container">
          <svg id = "usmap" height = 900 width = 1100 style = "background: white">
          </svg>
        </div>
        <svg id="colorLegend" height="100" width="600" style="background: white; margin-top:30px" >
        </svg>
      </div>

      <div class = "chart">
        <svg id = "piechart" height = 200 width = 200 style = "background: white">
        </svg>
        <svg id = "legend" height = 200 width = 200 style = "background:white">
        </svg>
        <p>Click on each state to see energy consumption breakdown.</p>

        <label id = "label">Choose Year</label>
        <input type="range" min="2010" max="2014" value="2010" id="slider" step="1" oninput="outputUpdate(value)">
        <output for="slider" id="year">2010</output>
      </div>



      <script>
      function outputUpdate(value) {
	       document.querySelector('#year').value = value;
       }

      const svg = d3.select("#usmap");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const requestData = async () => {
        // Drawing basic us map
        const us = await d3.json("./dataset/us.json");
        console.log(us);

        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
        var path = d3.geoPath().projection(projection);

        map.selectAll("path").data(states.features)
            .enter()
            .append("path")
              .attr("class","state")
            .attr("d", path)
            .attr("note", d => d.id);

        map.append("path")
            .datum(statesMesh)
              .attr("class","outline")
            .attr("d", path);

        map.append("rect")
            .attr("class","hoverover")
            .attr("width", 150)
            .attr("height", 160)
            .style("fill", "white")
            .style("opacity", 0.6)
            .style("visibility", "hidden");

        // Loading energy data
        const energyData = await d3.csv("./dataset/Energy_Census_and_Economic_Data_US_2010-2014.csv");
        //console.log(energyData);
        const stateEnergy = energyData.slice(0,51);
        console.log(stateEnergy);

        // Loading state ids --> used to combine map data and energy data
        const stateIDs = await d3.tsv("./dataset/us-state-names.tsv");

        // Using id to combine two datasets
        let stateInfos = {};
        let statePie = {};
        let idToState = {};
        stateIDs.forEach( row => {
          idToState[row.id] = row.name;
        });
        console.log(idToState);

        let stateid = 36;

        // Function to update legend according to data
        function updateLegend(minMax, colorScale){
          // Clear previous legends
          d3.select('#colorLegend').selectAll('g').remove();

          // Copy from lecture notes
          const legend = d3.select("#colorLegend");
          const legendWidth = legend.attr("width");
          const legendHeight = legend.attr("height");
          const barHeight = 60;
          const stepSize = 4;

          const pixelScale = d3.scaleLinear().domain([0,legendWidth-40]).range([minMax[0]-1,minMax[1]+1]);
          const barScale = d3.scaleLinear().domain([minMax[0]-1,minMax[1]+1]).range([0,legendWidth-40]);
          const barAxis = d3.axisBottom(barScale);

          legend.append("g")
            .attr("class", "colorbar axis")
            .attr("transform","translate("+(20)+","+(barHeight+5)+")")
            .call(barAxis);

          let bar = legend.append("g").attr("transform","translate("+(20)+","+(0)+")")
          for (let i=0; i<legendWidth-40; i=i+stepSize) {
            bar.append("rect")
              .attr("x", i)
              .attr("y", 0)
              .attr("width", stepSize)
              .attr("height",barHeight)
              .style("fill", colorScale( pixelScale(i) ));
          }

          bar.append("line").attr("stroke","white").attr("stroke-width",3).attr("x1", barScale(minMax[0])).attr("x2", barScale(minMax[0])).attr("y1", 0).attr("y1", barHeight+4);
          bar.append("line").attr("stroke","white").attr("stroke-width",3).attr("x1", barScale(minMax[1])).attr("x2", barScale(minMax[1])).attr("y1", 0).attr("y1", barHeight+4);


        }



        var color = d3.scaleOrdinal(d3.schemePastel1);
        var temp = {}
        // Creat pie chart of energy breakdown for selected state
        function createPieChart(data, stateid){
          d3.select('#piechart').selectAll('g').remove();


          data.forEach( d => {
            temp[d.category] = d.value;
          })

          var svg = d3.select("#piechart");
          var width = svg.attr("width");
          var height = svg.attr("height");

          var radius = Math.min(width, height) / 2;

          var pie = d3.pie().value(function(d) {return d.value})(data);

          var arc = d3.arc().outerRadius(radius-10).innerRadius(50);
          var labelArc = d3.arc().outerRadius(radius-40).innerRadius(radius-40);

          var chart = svg.append("g").attr("transform", "translate("+width/2+","+height/2+")");

          var g = chart.selectAll("arc").data(pie).enter().append("g").attr("class","arc").attr("note", d => d.data.category);
          g.append("path").attr("d",arc).style("fill", function(d) {return color(d.data.category);});
          g.append("text").text(idToState[stateid]).style("text-anchor", "middle").style("fill","black").style("font-size",25);

          d3.select("#piechart").selectAll("g").selectAll(".arc")
            .on("mouseover", function(){
              let category = d3.select(this).attr("note");
              d3.select("#piechart").append("text")
                .attr("id", category.replace(/[ _\-,.:'#!\?]/g,""))
                .attr("x", 135)
                .attr("y", 25)
                .text(category)
                .style("fill", "black");
                //.style("font-weight","bold");
              d3.select("#piechart").append("text")
                .attr("id", "category_value")
                .attr("x", 135)
                .attr("y", 45)
                .text((temp[category]*100).toFixed(2) + '%')
                .style("fill", "black");
              //  .style("font-weight","bold");
              d3.select(this).style("opacity",0.5);

            })
            .on("mouseout", function(){
              let category = d3.select(this).attr("note");
              d3.select(this).style("opacity",1);
              d3.select("#" + category.replace(/[ _\-,.:'#!\?]/g,"")).remove();
              d3.select("#category_value").remove();
            });

        }


        // Function to update map according to year
        function updateMap(value){

          let year = value;
          let coal = "CoalC" + year;
          let fossfuel = "FossFuelC" + year;
          let geo = "GeoC" + year;
          let hydro = "HydroC" + year;
          let natgas = "NatGasC" + year;
          let lpg = "LPGC" + year;

          stateEnergy.forEach( state => {
            let total = Number(state[coal]) + Number(state[fossfuel]) + Number(state[geo]) + Number(state[hydro]) + Number(state[natgas]) + Number(state[lpg])
            stateInfos[state.State] = total;

            statePie[state.State] = [{"category":"Coal", "value": Number(state[coal])/total}, {"category":"Foss", "value": (Number(state[fossfuel]) + Number(state[lpg]))/total}, {"category":"Geo", "value": Number(state[geo])/total}, {"category": "Hydro", "value": Number(state[hydro])/total}, {"category":"NatGas", "value": Number(state[natgas])/total}];
          });

          const minMax = d3.extent(stateIDs, d => stateInfos[d.name]);

          // const colorScale = d3.scaleSequential(d3.interpolateGnBu).domain(minMax);
          const colorScale = d3.scaleQuantile()
                                .domain(d3.values(stateInfos))
                                .range(["#DEEDCF", "#BFE1B0", "#99D492", "#74C67A", "#56B870", "#39A96B", "#1D9A6C", "#188977", "#137177", "#0E4D64", "#0A2F51"])
                                //.range(["#fff","#d0e1e5","#adc2da","#8879b3","#762b80"]);
          // const colorScale = d3.scaleQuantize()
          //                       .domain(minMax)
          //                       .range(["#f6fbfc","#adc2da","#8879b3","#762b80"]);

          // 3d. Recolor the states to make a choropleth


          map.selectAll(".state")
              .style("fill", d => colorScale( stateInfos[ idToState[d.id] ] ))
              .on("mouseover", function(){
                let id = d3.select(this).attr("note");
                let x = event.clientX + 150 >= 1000? event.clientX - 150 -100:event.clientX-60;
                let y = event.clientY + 160 >= 1000? 500:event.clientY-200;
                let display = d3.select(".hoverover");
                d3.select(this).style("opacity",0.5);
                display.style("visibility", "visible")
                  .attr("x", x)
                  .attr("y", y);
                // map.append("text")
                //   .text(d3.select(this).attr("note"))
                //   .attr("id", "state_information")
                //   .attr("x", x)
                //   .attr("y", y);
                for(let i = 0; i < statePie[idToState[id]].length; i++){
                  map.append("text")
                    .text(idToState[id])
                    .attr("x", x+5)
                    .attr("y", y+20)
                    .attr("class", "textinfo");
                  map.append("text")
                    .text(statePie[idToState[id]][i].category+": ")
                    .attr("x", x+5)
                    .attr("y", y+(i+1)*25+20)
                    .attr("class", "textinfo");
                  map.append("text")
                    .text((temp[statePie[idToState[id]][i].category]*100).toFixed(2) + '%')
                    .attr("x", x+15+statePie[idToState[id]][i].category.length*10)
                    .attr("y", y+(i+1)*25+20)
                    .attr("class", "textinfo");
                }
              })
              .on("mouseout", function(){
                d3.select(this).style("opacity",1);
                d3.select("#state_information").remove();
                d3.select(".hoverover").style("visibility", "hidden");
                d3.selectAll(".textinfo").remove();
              })
              .on("click", function(){
                stateid = d3.select(this).attr("note");
                createPieChart(statePie[idToState[stateid]], stateid);
              });

          updateLegend(minMax, colorScale);

        }




        // making slider
        updateMap(2010);
        createPieChart(statePie[idToState[stateid]], stateid);

        // create legend for piechart
        var legend = d3.select("#legend")
        for(let i = 0; i < statePie[idToState[stateid]].length; i++){
          legend.append("rect")
                .attr("x", 20)
                .attr("y", 20+i*30)
                .attr("width", 25)
                .attr("height", 25)
                .style("fill", color(statePie[idToState[stateid]][i].category));

          legend.append("text")
                .attr("x", 60)
                .attr("y", i*30+40)
                .attr("height", 25)
                .text(statePie[idToState[stateid]][i].category)
                .style("fill", "black");
                //.style("font-weight", "bold");

        }

        // var sliderDiv = d3.select(".chart").append("div").attr("class", "yearslider");
        //
        // sliderDiv.append("div").text("Year")
        //           .append("div")
        //           .append("input")
        //           .attr("type", "range")
        //           .style("width","200px")
        //           .attr("min", 2010)
        //           .attr("max", 2014)
        //           .attr("step", 1)
        //           .attr("value", 2010)

        // Update map and piechart according to current year
        d3.select("#slider").on("input", function () {
          updateMap(Number(this.value));
          createPieChart(statePie[idToState[stateid]], stateid);
        });

      }

      requestData();

      </script>

    </div>

  </div>
</body>
</html>
