<html>
<head>
<title>Project2</title>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link rel="stylesheet" href="./style.css">


</head>

<body leftmargin = "50" topmargin = "50">
  <div class="container larger">
    <h3>Energy Consumptions</h3>

    <div id = "map">
      <svg id = "usmap" height = 800 width = 1000 style = "background: #445; margin-top:50px">
      </svg>
      <svg id = "piechart" height = 200 width = 200 style = "background: black; margin-top: 50px">
      </svg>

      <svg id="colorLegend" height="100" width="600" style="background: #fff; margin-top:30px" >
      </svg>


      <script>
      const svg = d3.select("#usmap");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const requestData = async () => {
        // Drawing basic us map
        const us = await d3.json("./dataset/us.json");
        console.log(us);

        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
        var path = d3.geoPath().projection(projection);

        map.selectAll("path").data(states.features)
            .enter()
            .append("path")
            .attr("class","state")
            .attr("d", path)
            .attr("note", d => d.id);  // We used this for debugging

        map.append("path")
            .datum(statesMesh)
            .attr("class","outline")
            .attr("d", path);


        // Loading energy data
        const energyData = await d3.csv("./dataset/Energy_Census_and_Economic_Data_US_2010-2014.csv");
        //console.log(energyData);
        const stateEnergy = energyData.slice(0,51);
        console.log(stateEnergy);

        // Loading state ids --> used to combine map data and energy data
        const stateIDs = await d3.tsv("./dataset/us-state-names.tsv");

        // Using id to combine two datasets
        let stateInfos = {};
        let statePie = {};
        let idToState = {};
        stateIDs.forEach( row => {
          idToState[row.id] = row.name;
        });
        console.log(idToState);



        // Function to update legend according to data
        function updateLegend(minMax, colorScale){
          // Clear previous legends
          d3.select('#colorLegend').selectAll('g').remove();

          // Copy from lecture notes
          const legend = d3.select("#colorLegend");
          const legendWidth = legend.attr("width");
          const legendHeight = legend.attr("height");
          const barHeight = 60;
          const stepSize = 4;

          const pixelScale = d3.scaleLinear().domain([0,legendWidth-40]).range([minMax[0]-1,minMax[1]+1]);
          const barScale = d3.scaleLinear().domain([minMax[0]-1,minMax[1]+1]).range([0,legendWidth-40]);
          const barAxis = d3.axisBottom(barScale);

          legend.append("g")
            .attr("class", "colorbar axis")
            .attr("transform","translate("+(20)+","+(barHeight+5)+")")
            .call(barAxis);

          let bar = legend.append("g").attr("transform","translate("+(20)+","+(0)+")")
          for (let i=0; i<legendWidth-40; i=i+stepSize) {
            bar.append("rect")
              .attr("x", i)
              .attr("y", 0)
              .attr("width", stepSize)
              .attr("height",barHeight)
              .style("fill", colorScale( pixelScale(i) ));
          }

          bar.append("line").attr("stroke","white").attr("stroke-width",3).attr("x1", barScale(minMax[0])).attr("x2", barScale(minMax[0])).attr("y1", 0).attr("y1", barHeight+4);
          bar.append("line").attr("stroke","white").attr("stroke-width",3).attr("x1", barScale(minMax[1])).attr("x2", barScale(minMax[1])).attr("y1", 0).attr("y1", barHeight+4);


        }




        // Creat pie chart of energy breakdown for selected state
        function createPieChart(data){
          d3.select('#piechart').selectAll('g').remove();

          var svg = d3.select("#piechart");
          var width = svg.attr("width");
          var height = svg.attr("height");

          var radius = Math.min(width, height) / 2;
          var color = d3.scaleOrdinal(d3.schemeAccent);

          var pie = d3.pie().value(function(d) {return d.value})(data);

          var arc = d3.arc().outerRadius(radius-10).innerRadius(50);
          var labelArc = d3.arc().outerRadius(radius-40).innerRadius(radius-40);

          var chart = svg.append("g").attr("transform", "translate("+width/2+","+height/2+")");

          var g = chart.selectAll("arc").data(pie).enter().append("g").attr("class","arc");
          g.append("path").attr("d",arc).style("fill", function(d) {return color(d.data.category);});

          g.append("text")
          	.attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
            .style("text-anchor", "end")
          	.text(function(d) { return d.data.category;})
          	.style("fill", "#fff");


        }




        // Function to update map according to year
        function updateMap(value){

          let year = value;
          let coal = "CoalC" + year;
          let fossfuel = "FossFuelC" + year;
          let geo = "GeoC" + year;
          let hydro = "HydroC" + year;
          let natgas = "NatGasC" + year;
          let lpg = "LPGC" + year;

          stateEnergy.forEach( state => {
            let total = Number(state[coal]) + Number(state[fossfuel]) + Number(state[geo]) + Number(state[hydro]) + Number(state[natgas]) + Number(state[lpg])
            stateInfos[state.State] = total;

            statePie[state.State] = [{"category":"Coal", "value": Number(state[coal])/total}, {"category":"Foss", "value": (Number(state[fossfuel]) + Number(state[lpg]))/total}, {"category":"Geo", "value": Number(state[geo])/total}, {"category": "Hydro", "value": Number(state[hydro])/total}, {"category":"NatGas", "value": Number(state[natgas])/total}];
          });

          const minMax = d3.extent(stateIDs, d => stateInfos[d.name]);
          
          // const colorScale = d3.scaleSequential(d3.interpolateGnBu).domain(minMax);
          const colorScale = d3.scaleQuantile()
                                .domain(d3.values(stateInfos))
                                .range(["#fff","#d0e1e5","#adc2da","#8879b3","#762b80"]);
          // const colorScale = d3.scaleQuantize()
          //                       .domain(minMax)
          //                       .range(["#f6fbfc","#adc2da","#8879b3","#762b80"]);

          // 3d. Recolor the states to make a choropleth


          map.selectAll(".state")
              .style("fill", d => colorScale( stateInfos[ idToState[d.id] ] ))
              .on("mouseover", function(){
                d3.select(this).style("opacity",0.5);
              })
              .on("mouseout", function(){
                d3.select(this).style("opacity",1);
              })
              .on("click", function(){
                let stateid = d3.select(this).attr("note");
                createPieChart(statePie[idToState[stateid]]);
              });

          updateLegend(minMax, colorScale);

        }


        // making slider
        updateMap(2010);

        var sliderDiv = d3.select("#map").append("div");

        sliderDiv.append("div").text("Year")
                  .append("div")
                  .append("input")
                  .attr("type", "range")
                  .attr("class", "yearslider")
                  .style("width","300px")
                  .attr("min", 2010)
                  .attr("max", 2014)
                  .attr("step", 1)
                  .attr("value", 2010)
                  .on("input", function () {
                    updateMap(Number(this.value));
                  });

      }

      requestData();

      </script>

    </div>

  </div>
</body>
</html>
